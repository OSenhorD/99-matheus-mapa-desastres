const response = {
    "status": 200,
    "success": true,
    "last_update": 169,
    "count": 12,
    "messages": [],
    "data": [
        {
            "event_id_cnty": "BRA82328",
            "event_date": "2024-05-12",
            "year": "2024",
            "time_precision": "1",
            "disorder_type": "Political violence",
            "event_type": "Battles",
            "sub_event_type": "Armed clash",
            "actor1": "Unidentified Gang (Brazil)",
            "assoc_actor_1": "",
            "inter1": "3",
            "actor2": "Unidentified Gang (Brazil)",
            "assoc_actor_2": "",
            "inter2": "3",
            "interaction": "33",
            "civilian_targeting": "",
            "iso": "76",
            "region": "South America",
            "country": "Brazil",
            "admin1": "Minas Gerais",
            "admin2": "Vespasiano",
            "admin3": "",
            "location": "Vespasiano",
            "latitude": "-19.6919",
            "longitude": "-43.9233",
            "geo_precision": "1",
            "source": "Estado de Minas",
            "source_scale": "Subnational",
            "notes": "On 12 May 2024, in Vespasiano (Minas Gerais), unknown armed individuals shot and killed a man in the Novo Horizonte neighborhood. Portions of drugs and cash were found with the deceased (likely drug trafficker), and days before his killing he had had a disagreement with a local drug trafficking leader. 1 fatality.",
            "fatalities": "1",
            "tags": "",
            "timestamp": "1716240615"
        },
        {
            "event_id_cnty": "BRA82332",
            "event_date": "2024-05-12",
            "year": "2024",
            "time_precision": "1",
            "disorder_type": "Political violence",
            "event_type": "Battles",
            "sub_event_type": "Armed clash",
            "actor1": "Unidentified Gang and\/or Police Militia",
            "assoc_actor_1": "",
            "inter1": "3",
            "actor2": "Unidentified Gang (Brazil)",
            "assoc_actor_2": "",
            "inter2": "3",
            "interaction": "33",
            "civilian_targeting": "",
            "iso": "76",
            "region": "South America",
            "country": "Brazil",
            "admin1": "Minas Gerais",
            "admin2": "Betim",
            "admin3": "",
            "location": "Betim",
            "latitude": "-19.9668",
            "longitude": "-44.2009",
            "geo_precision": "1",
            "source": "G1",
            "source_scale": "National",
            "notes": "On 12 May 2024, in Betim (Minas Gerais), an unknown armed individual shot and killed a drug trafficker at a bar in the Icaivera neighborhood. 1 fatality.",
            "fatalities": "1",
            "tags": "",
            "timestamp": "1716240615"
        },
        {
            "event_id_cnty": "BRA82368",
            "event_date": "2024-05-12",
            "year": "2024",
            "time_precision": "1",
            "disorder_type": "Political violence",
            "event_type": "Violence against civilians",
            "sub_event_type": "Attack",
            "actor1": "Unidentified Gang and\/or Police Militia",
            "assoc_actor_1": "",
            "inter1": "3",
            "actor2": "Civilians (Brazil)",
            "assoc_actor_2": "Military Forces of Brazil (2023-) Military Police",
            "inter2": "7",
            "interaction": "37",
            "civilian_targeting": "Civilian targeting",
            "iso": "76",
            "region": "South America",
            "country": "Brazil",
            "admin1": "Ceara",
            "admin2": "Fortaleza",
            "admin3": "",
            "location": "Fortaleza",
            "latitude": "-3.7172",
            "longitude": "-38.5431",
            "geo_precision": "1",
            "source": "Diario do Nordeste; G1",
            "source_scale": "Subnational-National",
            "notes": "On 12 May 2024, in Fortaleza (Ceara), three unidentified armed individuals shot and killed a man in the Vila Velha neighborhood. The suspects were in a car when two of them got off the vehicle and fired against the victim, who was an off-duty military police officer, and escaped immediately. A military police car was at the street at the moment of the attack but did not chased the suspects. The victim was being investigated for being part of a militia group. A second person was also shot and injured. Authorship and motivations for the attack are unknown. 1 fatality.",
            "fatalities": "1",
            "tags": "",
            "timestamp": "1716240615"
        },
        {
            "event_id_cnty": "BRA82377",
            "event_date": "2024-05-12",
            "year": "2024",
            "time_precision": "1",
            "disorder_type": "Political violence",
            "event_type": "Violence against civilians",
            "sub_event_type": "Attack",
            "actor1": "Unidentified Gang and\/or Police Militia",
            "assoc_actor_1": "",
            "inter1": "3",
            "actor2": "Civilians (Brazil)",
            "assoc_actor_2": "",
            "inter2": "7",
            "interaction": "37",
            "civilian_targeting": "Civilian targeting",
            "iso": "76",
            "region": "South America",
            "country": "Brazil",
            "admin1": "Para",
            "admin2": "Ananindeua",
            "admin3": "",
            "location": "Ananindeua",
            "latitude": "-1.3656",
            "longitude": "-48.3722",
            "geo_precision": "1",
            "source": "O Liberal",
            "source_scale": "Subnational",
            "notes": "On 12 May 2024, in Ananindeua (Para), at least three armed individuals on two motorcycles killed a man in a drive-by shooting in the Icui-Guajara neighborhood. Authorship and motivation of the attack are unknown. 1 fatality.",
            "fatalities": "1",
            "tags": "",
            "timestamp": "1716240615"
        },
        {
            "event_id_cnty": "BRA82378",
            "event_date": "2024-05-12",
            "year": "2024",
            "time_precision": "2",
            "disorder_type": "Political violence",
            "event_type": "Violence against civilians",
            "sub_event_type": "Attack",
            "actor1": "Unidentified Armed Group (Brazil)",
            "assoc_actor_1": "",
            "inter1": "3",
            "actor2": "Civilians (Brazil)",
            "assoc_actor_2": "",
            "inter2": "7",
            "interaction": "37",
            "civilian_targeting": "Civilian targeting",
            "iso": "76",
            "region": "South America",
            "country": "Brazil",
            "admin1": "Sao Paulo",
            "admin2": "Aracatuba",
            "admin3": "",
            "location": "Aracatuba",
            "latitude": "-21.2089",
            "longitude": "-50.4328",
            "geo_precision": "1",
            "source": "G1",
            "source_scale": "National",
            "notes": "Around 12 May 2024 (as reported), in Aracatuba (Sao Paulo), a man was killed and his body was found on the Eliezer Montenegro Magalhaes highway. His body had shooting and self-defense marks, with injuries in his arms, shoulder, face, and skull. Motivation and perpetrators unknown. 1 fatality.",
            "fatalities": "1",
            "tags": "",
            "timestamp": "1716240615"
        },
        {
            "event_id_cnty": "BRA82386",
            "event_date": "2024-05-12",
            "year": "2024",
            "time_precision": "2",
            "disorder_type": "Political violence",
            "event_type": "Violence against civilians",
            "sub_event_type": "Attack",
            "actor1": "Unidentified Gang and\/or Police Militia",
            "assoc_actor_1": "",
            "inter1": "3",
            "actor2": "Civilians (Brazil)",
            "assoc_actor_2": "",
            "inter2": "7",
            "interaction": "37",
            "civilian_targeting": "Civilian targeting",
            "iso": "76",
            "region": "South America",
            "country": "Brazil",
            "admin1": "Amazonas",
            "admin2": "Itacoatiara",
            "admin3": "",
            "location": "Itacoatiara",
            "latitude": "-3.1361",
            "longitude": "-58.4368",
            "geo_precision": "2",
            "source": "Portal do Holanda",
            "source_scale": "Subnational",
            "notes": "Around 12 May 2024 (as reported), in the rural area of Itacoatiara municipality (Amazonas), a man was killed by unknown individuals and his body was found in the Livramento community, with signs of torture and beheaded. The victim had been missing since 10 May 2024. The victim had recently left prison (charges not specified). Circumstances of death are unknown. 1 fatality.",
            "fatalities": "1",
            "tags": "",
            "timestamp": "1716240616"
        },
        {
            "event_id_cnty": "BRA82387",
            "event_date": "2024-05-12",
            "year": "2024",
            "time_precision": "1",
            "disorder_type": "Political violence",
            "event_type": "Violence against civilians",
            "sub_event_type": "Attack",
            "actor1": "Unidentified Gang and\/or Police Militia",
            "assoc_actor_1": "",
            "inter1": "3",
            "actor2": "Civilians (Brazil)",
            "assoc_actor_2": "",
            "inter2": "7",
            "interaction": "37",
            "civilian_targeting": "Civilian targeting",
            "iso": "76",
            "region": "South America",
            "country": "Brazil",
            "admin1": "Alagoas",
            "admin2": "Maceio",
            "admin3": "",
            "location": "Maceio",
            "latitude": "-9.6658",
            "longitude": "-35.7353",
            "geo_precision": "1",
            "source": "Alagoas 24 Horas",
            "source_scale": "Subnational",
            "notes": "On 12 May 2024, in Maceio (Alagoas), unidentified armed individuals shot and killed a man in a drive-by shooting in the Clima Bom neighborhood. The suspects were on a motorcycle when they fired against the victim, who was at a local bar. The suspects escaped. Authorship and motivations for the attacks are unknown. 1 fatality.",
            "fatalities": "1",
            "tags": "",
            "timestamp": "1716240616"
        },
        {
            "event_id_cnty": "BRA82388",
            "event_date": "2024-05-12",
            "year": "2024",
            "time_precision": "1",
            "disorder_type": "Political violence",
            "event_type": "Violence against civilians",
            "sub_event_type": "Attack",
            "actor1": "Unidentified Gang and\/or Police Militia",
            "assoc_actor_1": "",
            "inter1": "3",
            "actor2": "Civilians (Brazil)",
            "assoc_actor_2": "",
            "inter2": "7",
            "interaction": "37",
            "civilian_targeting": "Civilian targeting",
            "iso": "76",
            "region": "South America",
            "country": "Brazil",
            "admin1": "Amazonas",
            "admin2": "Manaus",
            "admin3": "",
            "location": "Manaus",
            "latitude": "-3.1019",
            "longitude": "-60.0250",
            "geo_precision": "1",
            "source": "Portal do Holanda",
            "source_scale": "Subnational",
            "notes": "On 12 May 2024, in Manaus - East Zone (Amazonas), two armed individuals on a motorcycle killed a man in a drive-by shooting in the Armando Mendes neighborhood. The victim was a former prisoner (charges not specified), and had been receiving death threats. Authorship and motivation of the attack are unknown. 1 fatality.",
            "fatalities": "1",
            "tags": "",
            "timestamp": "1716240616"
        },
        {
            "event_id_cnty": "BRA82392",
            "event_date": "2024-05-12",
            "year": "2024",
            "time_precision": "1",
            "disorder_type": "Political violence",
            "event_type": "Violence against civilians",
            "sub_event_type": "Attack",
            "actor1": "Unidentified Gang and\/or Police Militia",
            "assoc_actor_1": "",
            "inter1": "3",
            "actor2": "Civilians (Brazil)",
            "assoc_actor_2": "",
            "inter2": "7",
            "interaction": "37",
            "civilian_targeting": "Civilian targeting",
            "iso": "76",
            "region": "South America",
            "country": "Brazil",
            "admin1": "Minas Gerais",
            "admin2": "Pouso Alegre",
            "admin3": "",
            "location": "Pouso Alegre",
            "latitude": "-22.2285",
            "longitude": "-45.9355",
            "geo_precision": "1",
            "source": "G1",
            "source_scale": "National",
            "notes": "On 12 May 2024, in Pouso Alegre (Minas Gerais), four armed individuals on a motorcycle killed a man in a drive-by shooting in the Sao Gerado neighborhood. The victim was a prisoner on temporary release (charges not specified). Authorship and motivation of the attack are unknown. 1 fatality.",
            "fatalities": "1",
            "tags": "",
            "timestamp": "1716240616"
        },
        {
            "event_id_cnty": "BRA82397",
            "event_date": "2024-05-12",
            "year": "2024",
            "time_precision": "1",
            "disorder_type": "Political violence",
            "event_type": "Violence against civilians",
            "sub_event_type": "Attack",
            "actor1": "Unidentified Gang and\/or Police Militia",
            "assoc_actor_1": "",
            "inter1": "3",
            "actor2": "Civilians (Brazil)",
            "assoc_actor_2": "",
            "inter2": "7",
            "interaction": "37",
            "civilian_targeting": "Civilian targeting",
            "iso": "76",
            "region": "South America",
            "country": "Brazil",
            "admin1": "Para",
            "admin2": "Braganca",
            "admin3": "",
            "location": "Braganca",
            "latitude": "-1.0536",
            "longitude": "-46.7656",
            "geo_precision": "1",
            "source": "O Liberal",
            "source_scale": "Subnational",
            "notes": "On 12 May 2024, in Braganca (Para), two armed individuals on a motorcycle opened fire against a group of people in a drive-by shooting in the Vila Sinha neighborhood, killing two men and injuring two women. Locals detained, beat up, and injured one suspect, and the other escaped. The attack motivation is unknown. 2 fatalities.",
            "fatalities": "2",
            "tags": "",
            "timestamp": "1716240616"
        },
        {
            "event_id_cnty": "BRA82398",
            "event_date": "2024-05-12",
            "year": "2024",
            "time_precision": "1",
            "disorder_type": "Political violence",
            "event_type": "Violence against civilians",
            "sub_event_type": "Attack",
            "actor1": "Unidentified Gang and\/or Police Militia",
            "assoc_actor_1": "",
            "inter1": "3",
            "actor2": "Civilians (Brazil)",
            "assoc_actor_2": "",
            "inter2": "7",
            "interaction": "37",
            "civilian_targeting": "Civilian targeting",
            "iso": "76",
            "region": "South America",
            "country": "Brazil",
            "admin1": "Minas Gerais",
            "admin2": "Contagem",
            "admin3": "",
            "location": "Contagem",
            "latitude": "-19.9317",
            "longitude": "-44.0536",
            "geo_precision": "1",
            "source": "G1",
            "source_scale": "National",
            "notes": "On 12 May 2024, in Contagem (Minas Gerais), unknown armed individuals shot and killed a man in the Estrela Dalva neighborhood. The victim was shot at least 17 times, likely indicating an execution. In the Industrial Sao Luiz neighborhood, an armed individual on a motorcycle shot and killed a man in a drive-by shooting. Attack motivation for both events is unknown. 2 fatalities.",
            "fatalities": "2",
            "tags": "",
            "timestamp": "1716240616"
        },
        {
            "event_id_cnty": "BRA82405",
            "event_date": "2024-05-12",
            "year": "2024",
            "time_precision": "1",
            "disorder_type": "Political violence",
            "event_type": "Riots",
            "sub_event_type": "Mob violence",
            "actor1": "Rioters (Brazil)",
            "assoc_actor_1": "Vigilante Group (Brazil)",
            "inter1": "5",
            "actor2": "Civilians (Brazil)",
            "assoc_actor_2": "",
            "inter2": "7",
            "interaction": "57",
            "civilian_targeting": "Civilian targeting",
            "iso": "76",
            "region": "South America",
            "country": "Brazil",
            "admin1": "Amazonas",
            "admin2": "Manaus",
            "admin3": "",
            "location": "Manaus",
            "latitude": "-3.1019",
            "longitude": "-60.0250",
            "geo_precision": "1",
            "source": "Portal do Holanda",
            "source_scale": "Subnational",
            "notes": "On 12 May 2024, in Manaus - North Zone (Amazonas), residents in the Viver Melhor housing complex, in the Lago Azul neighborhood, beat up and injured a suspected thief. Emergency responders took the suspect to a hospital.",
            "fatalities": "0",
            "tags": "crowd size=no report",
            "timestamp": "1716240616"
        }
    ],
    "filename": "2024-05-12-brazil"
}

var map = null
var markers = []

const getData = async () => {
    const items = Array.isArray(response.data) ? response.data : []
    return items
}

const startMap = async () => {
    const items = await getData()

    const center = items.length == 0
        ? [-23.563113336677063, -46.64004646220451]
        : [items[0].latitude, items[0].longitude]

    map = L.map('map')
        .setView(center, 13)
        .setMinZoom(5)

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map)

    markers = []
    for (const item of items) {
        const maker = L.marker([item.latitude, item.longitude])
            .addTo(map)
            .bindPopup(`${item.notes}`)
        markers.push(maker)
    }

    buildOptions(items)
}

const center = (item = {}) => {
    map.setView([item.latitude, item.longitude], 13)

    const marker = markers.find(marker => marker._latlng.lat == item.latitude && marker._latlng.lng == item.longitude)
    if (!marker) return

    marker.openPopup()
}

const buildOptions = (items = []) => {
    const doc = document.getElementById("options")
    if (!doc) {
        console.log(`Elemento "options" não encontrado`)
        return
    }

    items = items.sort((a, b) => a.admin1 > b.admin1 ? 1 : (a.admin1 < b.admin1 ? - 1 : 0))

    while (items.length > 0) {
        const state = items[0].admin1
        const city = items
            .filter(item => item.admin1 == state)
            .sort((a, b) => a.admin2 > b.admin2 ? 1 : (a.admin2 < b.admin2 ? - 1 : 0))
        [0].admin2

        const occurrences = items.filter(item => item.admin1 == state && item.admin2 == city)
        items = items
            .filter(item => !(item.admin1 == state && item.admin2 == city))
            .sort((a, b) => {
                const dateA = new Date(`${a.event_date} 00:00:00`)
                const dateB = new Date(`${b.event_date} 00:00:00`)
                return dateA.getTime() > dateB.getTime() ? 1 : (dateA.getTime() < dateB.getTime() ? - 1 : 0)
            })

        const div = document.createElement("div")
        div.classList.add("city")
        div.innerHTML = `${state} - ${city}`

        for (const occurrence of occurrences) {
            const spanDate = document.createElement("span")
            spanDate.innerHTML = `${occurrence.event_date}`

            const spanType = document.createElement("span")
            spanType.classList.add("type")
            spanType.innerHTML = `${occurrence.disorder_type}`

            const divOccurrence = document.createElement("div")
            divOccurrence.classList.add("occurrence")
            divOccurrence.appendChild(spanDate)
            divOccurrence.appendChild(spanType)

            divOccurrence.addEventListener("click", () => center(occurrence))

            div.appendChild(divOccurrence)
        }

        doc.appendChild(div)
    }
}

startMap()
